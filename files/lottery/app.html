<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.rawgit.com/Chalarangelo/mini.css/v3.0.1/dist/mini-default.min.css">
    <link rel="stylesheet" href="css/app.css">
</head>
<body>
    <div id="app">
        <div id="pageLoading" class="page page-loading visible">
            <div class="spinner"></div>
        </div>
        <div id="pageIndex" class="page">
            <div id="lottery-form">
                <h3 id="formTitle"></h3>
                <p id="formDescription"></p>
                <div class="input-group fluid">
                    <label for="username">姓名</label>
                    <input type="text" id="username" placeholder="输入2-4个汉字" />
                </div>
                <div class="input-group fluid">
                    <label for="username">手机</label>
                    <input type="text" id="mobile" placeholder="输入11位手机号码" />
                </div>
                <div class="input-group vertical">
                    <button id="sendUserInfo" class="primary">提交开始抽奖</button>
                </div>
            </div>
        </div>
        <div id="pageLottery" class="page page-lottery"></div>
    </div>

    <script>
        const qs = (elem) => document.querySelector(elem);
        const qsa = (elems) => document.querySelectorAll(elems);
        const stringify = JSON.stringify;
        const ls = window.localStorage;
        const $body = qs('body');
        const $app = qs('#app');
        // service 
        let service = {
            index(id = 2) {
                return fetch(`https://form.powski.cn/forms/${id}`).then(res => res.json());
            },
            user({ id = 1, mobile = '', username =''} = {}) {
                let option = {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: stringify({ mobile, username})
                };
                return fetch(`https://form.powski.cn/forms/${id}/formdata`, option).then(res => res.json());
            }
        };

        let lottery = {
            timer: null,
            selectIndex: 0,
            speed: 100,
            couter: 0,
            loop: 40,
            win: 0,
            roll() {
                let allItems = qsa('[class*="prize"]');
                allItems.forEach(item => item.classList.remove('selected'));
                qs(`.prize-${this.couter % 8}`).classList.add('selected');
            },
            draw(elem) {
                this.timer = setTimeout(() => {
                    this.couter++;
                    if (this.couter > this.loop + this.win - 6) {
                        this.speed += 100;
                    }
                    this.roll();
                    if (this.couter < this.loop + this.win) {
                        this.draw();
                    } else {
                        this.couter = 0;
                        this.speed = 100;
                        // app.switchPage('Loading');
                        app.initPrizePage();
                        ls.participation = true;
                        clearTimeout(this.timer);
                    }
                }, this.speed);
            },
            initLotteryPage(data) {
                let createItem = (index) => {
                    return `
                    <div class="item prize-${index}">
                        <div class="prize-level">${data[index]['prize_item_name']}</div>
                        <div class="prize-name">${data[index]['prize_name']}</div>
                    </div>
                    `
                }
                let pageSource = `
                    <div class="lottery">
                        ${createItem(0)}
                        ${createItem(1)}
                        ${createItem(2)}
                        ${createItem(7)}
                        <div id="drawBtn" class="item prize"></div>
                        ${createItem(3)}
                        ${createItem(6)}
                        ${createItem(5)}
                        ${createItem(4)}
                </div>`;
                qs('#pageLottery').innerHTML = pageSource;
                app.switchPage('Index');
                qs('#drawBtn').addEventListener('click', () => {
                    this.draw();
                })
            },
            init(data) {
                this.initLotteryPage(data);
            }
        };
        
        let pageLoading = new Promise((resolve, reject) => {
            setTimeout(() => {
                resolve(1);
            }, 300);
        });

        let app = {
            currentPage: '',
            toast(message) {
                if (qsa('.toast').length) return;
                let toast = document.createElement('div');
                toast.className = 'toast';
                toast.innerHTML = message;
                $body.appendChild(toast);
                setTimeout(() => toast.remove(), 1000);
            },
            validateForm() {
                let $name = qs('#username'), $mobile = qs('#mobile');
                if ([$name, $mobile].every(item => !item.value)) {
                    this.toast('请填写表单');
                    return false;
                }
                if ($name.value.length < 2) {
                    this.toast('请正确填写姓名');
                    return false;
                }
                if ($mobile.value.length < 11) {
                    this.toast('请正确填写手机号');
                    return false;
                }
                return true;
            },
            switchPage(pageName, cb) {
                qsa('.page').forEach(page => page.classList.remove('visible'));
                qs(`#page${pageName}`).classList.add('visible');
                cb && cb();
            },
            initPrizePage() {
                let html = document.createElement('div');
                let prize = this.prize;
                html.id = 'pageAck';
                html.className = 'page'
                html.innerHTML = `
                    <h3>${this.indexData.winText}</h3>
                    <h3>${prize.prize_item_name}</h3>
                    <p>${prize.prize_name}</p>
                    <p>${this.indexData.acceptDesc}</p>
                    <p>谢谢您的参与</p>
                `;
                $app.appendChild(html);
                setTimeout(() => this.switchPage('Ack'), 100);
            },
            initIndexPage() {
                let that = this;
                service.index().then(res => {
                    app.indexData = res;
                    qs('#formTitle').innerHTML = res.title;
                    qs('#formDescription').innerHTML = res.desc;
                    app.switchPage('Index');
                    qs('#sendUserInfo').addEventListener('touchend', () => {
                        if (this.validateForm()) {
                            service.user({ mobile: qs('#mobile').value, username: qs('#username').value }).then(res => {
                                console.log(res);
                                that.prize = res.prize;
                                lottery.win = app.prize.id - 1;
                                app.switchPage('Lottery', lottery.init(app.indexData.prizes));
                            });
                        }
                    }, false);
                });
                
            },
            init() {
                this.initIndexPage();
            }
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        }, false);
    </script>
    <style>

    </style>
</body>
</html>